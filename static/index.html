<html>

    <head>
        <style>

            *{
                font-family: sans-serif;
                font-size: 12px;
            }

            body{
                width: 100%;
                height: 100%;
                border: 0px;
                margin: 0px;
            }

            #main{
                box-shadow: 0px 0px 8px grey;
                width: 50%;
                min-width: 480px;
                padding: 20px;
                box-sizing: border-box;
                margin: auto;
                margin-top: 80px;
                background: white;
            }

            #menu{
                width: 100%;
                position: fixed;
                top: 0px;
                left: 0px;
                height: 40;
                box-shadow: 0px 0px 8px grey;
                padding: 5px;
                box-sizing: border-box;
                background: white;
                z-index: 1;
            }

            #menu input[type="text"]{
                width: 300px;
                border: 1px solid lightgray;
            }

            .box{
                width: 120px;
                height: 200px;
                float: left;
                position: relative;
                margin: 2px;
            }

            ul{
                list-style-type: none;
            }

            .box img{
                width: 100%;
                cursor: pointer;
            }

            .box .label {
                position: absolute;
                top: 0px;
                background: rgba(0,0,0,0.5);
                color: white;
                width: 100%;
                padding: 5px;
                box-sizing: border-box;
            }

            .season_box{
                border: 1px solid lightgray;
                padding: 5px;
                margin-bottom: 20px;
                border-radius: 5px;
                position: relative;
                padding-top: 15px;

                column-count: auto;
                column-width: 200px;
            }

            .season_box .season_flag{
                position: absolute;
                top: -15px;
                left: -10px;
                background: white;
                padding: 3px;
                font-weight: 600;
                border: 1px solid lightgray;
            }

            #downloads{
                width: auto;
                padding: 20px;
                box-shadow: 0px 0px 8px gray;
                position: fixed;
                top: 100px;
                background: white;
            }

            .season_flag label{
                float: left;
                font-style: italic;
            }

            .season_flag .check{
                float: left;
                width: 3.2em;
                height: 1.6em;
                border: 0.1em solid lightgray;
                border-radius: 1em;
                margin-left: 2.0em;
                box-sizing: border-box;
                position: relative;
                transition: background-color 1s ease;
            }

            .episode .check{
                width: 3.2em;
                height: 1.6em;
                border: 0.1em solid lightgray;
                border-radius: 1em;
                margin: 0.5em;
                box-sizing: border-box;
                position: relative;
                transition: background-color 1s ease;
            }

            .check .block{
                border: 0.1em solid lightgray;
                width: 1.6em;
                height: 1.6em;
                border-radius: 1em;
                background-color: white;
                margin: -0.18em 0px 0px -0.2em;
                transition: left 0.5s ease;
                
                position: absolute;
                left: 0px;
                box-shadow: 0px 0px 5px lightgray;
                
            }

            .check .blockon{
                left: 1.6em;
            }

            .checkon{
                background-color: cornflowerblue;
            }

            .episode{
                display: inline-flex;
            }

            .episode label{
                margin: auto;
            }

            .progressbar{
                border: 1px solid lightgray;
                width: 100px;
                height: 20px;
            }

            .progressbar .bar{
                background: dodgerblue;
                height: 100%;
                padding: 2px;
                box-sizing: border-box;
            }

        </style>

        <script type="text/javascript">

            var db = {};
            var interval;
            var interval_enabled = false;


            window.onload=function(){
                downloads_daemon();
            }


            function shortner(str, size){
                if (str.length>size) return str.substr(0,size)+"..";
                return str;
            }


            function ajax(method, url, param, content, callback) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        callback(this.responseText);
                    }else if (this.readyState == 4){
                        callback
                    }
                };
                xhttp.open(method, url, true);
                if (content!="") xhttp.setRequestHeader("Content-Type", content)
                xhttp.send(param);
            }


            function find_episodes(link){

                db = {};

                console.log("apro "+link)
                ajax("POST", "http://127.0.0.1:5000/find_episodes", "{\"link\":\""+link+"\"}", "application/json", function(x){
                    var list = JSON.parse(x);

                    document.getElementById("main").innerHTML = "";



                    for (var c=0;c<list.length;c++){
                        
                        var s = list[c]["s"];
                        var e = list[c]["e"];
                        var name = list[c]["name"];
                        var link = list[c]["link"];

                        var x = document.getElementById("season_"+s);
                        if (x===null){
                            x = document.createElement("div");
                            x.id = "season_"+s;
                            x.className = "season_box";
                            document.getElementById("main").appendChild(x);

                            x.innerHTML = "<div class='season_flag'><label>Season "+s+"</label><div data-e='*' data-s='"+s+"' onclick='season_selector(this)' class='check'><div class='block'></div></div></div>";
                        }

                        x.innerHTML += "<div class='episode'><div tabindex='"+(c+1)+"' data-s='"+s+"' data-name='"+name+"' data-e='"+e+"' data-link='"+link+"' onkeypress='check_space(event, this)' onclick='check_click(this)' class='check'><div class='block'></div></div><label>"+shortner(s+"x"+e+" - "+name,30)+"</label></div>";
                        //x.innerHTML += "<div class='episode'><input data-s='"+s+"' data-name='"+name+"' data-e='"+e+"' data-link='"+link+"' type='checkbox'/><label>"+shortner(s+"x"+e+" - "+name,30)+"</label></div>";
                    }

                    document.getElementById("main").innerHTML += "<input type='button' value='download' onclick='download()'/>";
                    document.getElementById("main").innerHTML += "<input id='path' type='text' value='C:&#92;Users&#92;bingo&#92;Desktop&#92;lw&#92;' placeholder='destination path..'/>";

                });

            }


            function find_serie(name){

                console.log("cerco "+name);
                ajax("GET", "http://127.0.0.1:5000/find_serie/"+name, "", "", function(x){
                    var list = JSON.parse(x);

                    document.getElementById("main").innerHTML = "";

                    for (var c=0;c<list.length;c++){
                        var name = list[c].name;
                        var link = list[c].link;
                        var img = list[c].img;
                        document.getElementById("main").innerHTML += "<div onclick='find_episodes(\""+encodeURI(link)+"\")' class='box'><img src='"+img+"'/><div class='label'>"+name+"</div></div>";
                    }

                    document.getElementById("main").innerHTML += "<div style='clear: both'></div>";

                });

            }


            function downloads_daemon(){
                clearInterval(interval);
                interval = setInterval(function(){

                    interval_enabled=true;
                    
                    get_downloads(function(num){
                        if (num==0){

                            clearInterval(interval);
                            interval_enabled=false;

                        }
                    });
                },1000);
            }


            function get_downloads(callback){

                

                ajax("GET", "http://127.0.0.1:5001/get_downloads", "", "", function(x){
                    var list = JSON.parse(x);


                    

                    var tbody = document.getElementById("downloads_table");
                    var html = "";

                    for (c in list){
                        var ele = list[c];
                        var per = ele["percentage"];//(ele["len"]==undefined?0:Math.round(ele["cpos"]*100/ele["len"]));
                        console.log(ele);
                        html += "<tr><td><input type='button' value='Stop'/></td><td>"+ele.s+"x"+ele.e+" - "+shortner(ele.name,20)+"</td><td>";
                        html += "<div class='progressbar'><div class='bar' style='width: "+per+"px'>"+per+"</div></div>";
                        html += "</td></tr>";

                    }

                    

                    tbody.innerHTML = html;


                    
                    /*
                    var x = document.getElementsByClassName("epi");
                    
                    
                    
                    for (c=0;c<x.length;c++){
                        var ele = x[c];
                        var v = parseInt(ele.getAttribute("data-n"));
                        if (v>4) ele.remove();
                        else{
                            ele.setAttribute("data-n", v+1);
                        }
                    }


                    
                    var downloads = document.getElementById("downloads");

                    for (c in list){
                        var ele = list[c];
                        
                        var id = ele["s"]+"x"+ele["e"]+" - "+ele["name"];

                        var target = document.getElementById(id);
                        if (target==undefined){
                            
                            var tmp = "<tr class='epi' data-n='0' id='"+id+"'><td><img src='static/pause.png'/><img src='static/stop.png'/></td><td>"+ele.s+"x"+ele.e+" - "+shortner(ele.name,20)+"</td><td>";
                            tmp += "<div class='progressbar'><div class='bar'></div></div>";
                            tmp += "</td></tr>";
                            
                            downloads.children[0].children[0].innerHTML += tmp;
                            
                        }else{

                            var per = (ele["len"]==undefined?0:Math.round(ele["cpos"]*100/ele["len"]));

                            target.children[2].firstChild.children[0].innerHTML = per;
                            target.children[2].firstChild.children[0].style.width = per+"px";
                            target.setAttribute("data-n", 0);
                            

                        }
                    }
                    */
                    if (callback !== undefined) callback(list.length);

                });
            }


            function season_selector(check){
                check_click(check);

                var s = check.getAttribute("data-s");
                var checks = document.getElementById("season_"+s).getElementsByClassName("check");

                for (c=1;c<checks.length;c++){
                    var ele = checks[c];
                    if (check.className!=ele.className) ele.click();
                }

            }


            function check_click(check){

                var s = check.getAttribute("data-s");
                var e = check.getAttribute("data-e");
                var name = check.getAttribute("data-name");
                var link = check.getAttribute("data-link");


                
                var block = check.firstChild;
                if (block.className.indexOf("blockon")>0){
                    block.className = "block";
                    check.className = "check";
                    if (e!="*") delete db[s+"x"+e];
                }else{
                    block.className = "block blockon";
                    check.className = "check checkon";
                    if (e!="*") db[s+"x"+e] = {'s':s, 'e':e, 'name':name, 'link':link};
                }
                
                
            }


            function check_space(e, check){

                if (e.keyCode==32) check_click(check);
                e.preventDefault();
                e.stopPropagation();

            }


            function download(){

                var path = document.getElementById("path").value;
                list = []

                if (path.length==0){
                    alert("path invalid");
                    return;
                }

                for (var c in db){
                    var ele = db[c];
                    ele["path"] = path;
                    list.push(ele);
                }

                console.log(list);

                ajax("POST", "http://127.0.0.1:5001/download", JSON.stringify(list), "", function(x){
                    downloads_daemon();
                });



            }


        </script>
    </head>

    <body>

        <div id="menu">
            <input type="text" placeholder="nome serie" onkeyup="if (event.keyCode==13) find_serie(this.value);"/>
            
        </div>

        <div id = "main">
            <!--<div onclick="check_click(this)" class="check"><div class="block"></div></div>-->
        </div>
        <div id = "downloads">
            <table>
                <tr><th>cmd</th><th>name</th><th>status</th></tr>
                <tbody id="downloads_table">
                </tbody>
            </table>
        </div>
        
    </body>

<html>